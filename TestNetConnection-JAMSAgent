Import-Module JAMS

$agentList = [MVPSI.JAMS.Agent]::Find("*","localhost") 

$count = 0

#The agent running on the primary engine is a special case we have to check for
$primaryEngineName = "infjamdv01.svc.rldev.com"

Foreach($a in $agentList)
  {
  $count++

  Write-host "Checking agent $count of " $agentList.Count

  #first we want to see if the agent is the local host and if it is we can skip this iteration in the loop
  if($a.AgentName  -eq $primaryEngineName)
  {
  Write-host "The agent $a is on the primary engine."
   if((Get-Service JAMSAgent).Status -eq "Running")
    {
    Write-host "This agent is running successfully on the local host $($a.AgentName) `n" -ForegroundColor Green
    }
    else
    {
    Write-host "This agent is not running properly on the local host $($a.AgentName) `n" -ForegroundColor Red

    # $body = "$a is offline."
    # Send-MailMessage -To <<CheckNodeEmail>> -From <<JAMS.FromAddress>> -SmtpServer <<JAMS.SMTPServer>> -Subject "ERROR: JAMS $a is offline" -Body "$body"
    }
    continue
  }

  if ( $a.Online)
    {

    Write-host "$a is set to online"
    if(Test-NetConnection -Cn $a.AgentName -Port 77 -InformationLevel quiet)
     {
        Write-host "Received response from server $($a.AgentName) `n" -ForegroundColor Green
     }
     else
    {
        Write-host "Could not connect to the server $($a.AgentName) `n" -ForegroundColor Red

        # $body = "$a is offline."
        # Send-MailMessage -To <<CheckNodeEmail>> -From <<JAMS.FromAddress>> -SmtpServer <<JAMS.SMTPServer>> -Subject "ERROR: JAMS $a is offline" -Body "$body"
    }

    }
  if (! $a.Online)
    {
    Write-host "$a is set to offline" -ForegroundColor Red

  	if(Test-NetConnection -Cn $a.AgentName -Port 77 -InformationLevel quiet)
      {
      Write-host "Agent is set to offline, but you were able to Connect to the server $($a.AgentName)" -ForegroundColor Green
    }
    else
    {
    Write-host "The Agent is set to offline and you could not connect to the server $($a.AgentName)" -ForegroundColor Red

    # $body = "$a is offline."
    # Send-MailMessage -To <<CheckNodeEmail>> -From <<JAMS.FromAddress>> -SmtpServer <<JAMS.SMTPServer>> -Subject "ERROR: JAMS $a is offline" -Body "$body"
    }
  }
  }
